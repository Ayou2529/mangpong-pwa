const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/login-D6tg91Tp.js","assets/errors-DGYLFxor.js","assets/register-CgE9XB9X.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=o(n);fetch(n.href,r)}})();const O="modulepreload",M=function(e){return"/"+e},q={},D=function(t,o,s){let n=Promise.resolve();if(o&&o.length>0){let l=function(a){return Promise.all(a.map(d=>Promise.resolve(d).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),i=c?.nonce||c?.getAttribute("nonce");n=l(o.map(a=>{if(a=M(a),a in q)return;q[a]=!0;const d=a.endsWith(".css"),p=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${a}"]${p}`))return;const m=document.createElement("link");if(m.rel=d?"stylesheet":O,d||(m.as="script"),m.crossOrigin="",m.href=a,i&&m.setAttribute("nonce",i),document.head.appendChild(m),d)return new Promise((y,g)=>{m.addEventListener("load",y),m.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${a}`)))})}))}function r(c){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=c,window.dispatchEvent(i),!i.defaultPrevented)throw c}return n.then(c=>{for(const i of c||[])i.status==="rejected"&&r(i.reason);return t().catch(r)})};function v(e,t){try{return localStorage.setItem(e,t),!0}catch(o){if(console.error("localStorage setItem failed:",o),A())try{const s=JSON.parse(E("mangpongJobs")||"[]");if(s.length>10){const n=s.slice(-10);return v("mangpongJobs",JSON.stringify(n)),v(e,t),!0}}catch(s){console.error("localStorage cleanup failed:",s)}return!1}}function E(e,t=null){try{return localStorage.getItem(e)||t}catch(o){return console.error("localStorage getItem failed:",o),t}}function J(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("localStorage removeItem failed:",t),!1}}function A(){return/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&navigator.maxTouchPoints>1}const S={requests:[],isProcessing:!1,add:function(e){this.requests.push({data:e,timestamp:Date.now(),attempts:0}),this.saveToStorage(),console.log("Request added to queue:",e)},process:async function(){if(!(this.isProcessing||this.requests.length===0||!navigator.onLine)){this.isProcessing=!0;try{for(;this.requests.length>0;){const e=this.requests[0];e.attempts++;try{console.log(`Processing queued request (attempt ${e.attempts}):`,e.data);const t=await P(e.data);this.requests.shift(),this.saveToStorage(),console.log("Queued request processed successfully")}catch(t){console.warn(`Queued request failed (attempt ${e.attempts}):`,t),e.attempts>=3?(console.error("Request failed after 3 attempts, removing from queue:",e.data),this.requests.shift(),this.saveToStorage()):await new Promise(o=>setTimeout(o,1e3*e.attempts))}}}finally{this.isProcessing=!1}}},saveToStorage:function(){try{v("mangpongRequestQueue",JSON.stringify(this.requests))}catch(e){console.error("Failed to save request queue to storage:",e)}},loadFromStorage:function(){try{const e=E("mangpongRequestQueue");e&&(this.requests=JSON.parse(e),console.log("Loaded request queue from storage:",this.requests))}catch(e){console.error("Failed to load request queue from storage:",e)}},clear:function(){this.requests=[],this.saveToStorage()}};function C(e){return navigator.onLine?R(e,3):(console.log("Offline - queuing request:",e),S.add(e),Promise.resolve({success:!0,message:"Request queued for later processing"}))}async function R(e,t=3){for(let o=1;o<=t;o++)try{return console.log(`Attempt ${o} to connect to Google Sheets`),await P(e)}catch(s){if(console.warn(`Attempt ${o} failed:`,s.message),o===t)return console.log("All attempts failed - queuing request for later:",e),S.add(e),{success:!0,message:"Request queued for later processing"};const n=Math.min(1e3*Math.pow(2,o-1),1e4);await new Promise(r=>setTimeout(r,n))}}function P(e){return new Promise((t,o)=>{if(!window.GOOGLE_SCRIPT_URL){o(new Error("Google Script URL ไม่ได้ถูกกำหนดไว้"));return}const s="jsonpCallback_"+Date.now();window[s]=l=>{t(l),i()};const n=new URLSearchParams({...e,callback:s}).toString(),r=document.createElement("script");r.src=`${window.GOOGLE_SCRIPT_URL}?${n}`,r.onerror=()=>{o(new Error("ไม่สามารถเชื่อมต่อกับ Google Apps Script ได้")),i()};const c=setTimeout(()=>{o(new Error("การเชื่อมต่อกับ Google Apps Script หมดเวลา")),i()},45e3);function i(){clearTimeout(c),delete window[s],r.parentNode&&r.parentNode.removeChild(r)}document.body.appendChild(r)})}function T(){const e=new Date,t=e.getFullYear()+543,o=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],n=["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"][e.getDay()],r=e.getDate(),c=o[e.getMonth()],i=t,l=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0"),d=`${n} ${r} ${c} ${i} ${l}:${a}`,p=document.getElementById("current-date-time");p&&(p.textContent=d);const m=`${c} ${i}`,y=document.getElementById("current-month");y&&(y.textContent=m);const g=document.getElementById("selected-date");g&&(g.value=j(e));const h=document.getElementById("job-date-picker");h&&(h.value=j(e))}function j(e){const t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${o}-${s}`}function F(e){const t=new Date(e),o=t.getFullYear()+543,s=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],n=t.getDate(),r=s[t.getMonth()];return`${n}/${r}/${o}`}let $="login-screen";function I(e){$=e,["login-screen","register-screen","app"].forEach(o=>{const s=document.getElementById(o);s?o===$?s.classList.remove("hidden"):s.classList.add("hidden"):console.warn(`Page element with ID '${o}' not found`)})}function x(e){const t=document.getElementById("home-screen"),o=document.getElementById("new-job-screen"),s=document.getElementById("history-screen");t&&t.classList.add("hidden"),o&&o.classList.add("hidden"),s&&s.classList.add("hidden");const n=document.getElementById(e);if(n&&n.classList.remove("hidden"),document.querySelectorAll(".nav-item").forEach(r=>{r.classList.remove("active")}),e==="home-screen"){const r=document.querySelectorAll(".nav-item")[0];r&&r.classList.add("active")}else if(e==="new-job-screen"){const r=document.querySelectorAll(".nav-item")[1];r&&r.classList.add("active");const c=document.getElementById("edit-job-id").value;c&&console.log("Entering edit mode for job:",c)}else if(e==="history-screen"){const r=document.querySelectorAll(".nav-item")[2];r&&r.classList.add("active")}}function k(){const e=document.getElementById("edit-job-id");e&&(e.value=""),x("new-job-screen")}function _(){const e=document.getElementById("edit-job-id");e&&(e.value=""),x("home-screen")}function L(e){try{if(!e)throw new Error("Job ID is required");}catch(t){console.error("Error editing job:",t),Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:`ไม่สามารถแก้ไขงานได้: ${t.message}`,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function U(e){}let b=null,f=null,w=0;const G=300*1e3;function N(){T(),H(!0),W(),Q(!0),document.querySelectorAll(".amount-input").forEach(e=>{e.addEventListener("input",updateTotalAmount)}),setInterval(()=>{navigator.onLine&&Y()},300*1e3)}async function H(e=!1){const t=await B(e),o=t.filter(l=>l.status==="incomplete"),s=t.filter(l=>l.status==="draft"),n=document.getElementById("incomplete-jobs-card"),r=document.getElementById("incomplete-jobs-list");n&&r&&(o.length>0?(n.classList.remove("hidden"),r.innerHTML="",o.forEach(l=>{const a=document.createElement("li");a.textContent=`${l.jobId}: ${l.incompleteReason||"ข้อมูลไม่ครบถ้วน"}`,a.className="cursor-pointer hover:text-indigo-600",a.onclick=function(){L(l.jobId)},r.appendChild(a)})):n.classList.add("hidden"));const c=document.getElementById("draft-jobs-card"),i=document.getElementById("draft-jobs-list");c&&i&&(s.length>0?(c.classList.remove("hidden"),i.innerHTML="",s.forEach(l=>{const a=document.createElement("li");a.textContent=`${l.jobId}: ${l.company||"ไม่ระบุบริษัท"}`,a.className="cursor-pointer hover:text-indigo-600",a.onclick=function(){L(l.jobId)},i.appendChild(a)})):c.classList.add("hidden"))}async function B(e=!1){const t=Date.now();if(!e&&f&&t-w<G)return console.log("Using cached job data"),f;if(!navigator.onLine&&f)return console.log("Using expired cached job data due to offline status"),f;try{console.log("Fetching fresh job data from Google Sheets");const o=await C({action:"getJobs",username:b.username});if(o&&o.success&&o.jobs)return f=o.jobs,w=t,v("mangpongJobs",JSON.stringify(o.jobs)),o.jobs;{if(f)return console.warn("API failed, using cached data"),f;const s=E("mangpongJobs");if(s)try{const n=JSON.parse(s);return f=n,w=t,n}catch(n){console.error("Error parsing local jobs:",n)}return[]}}catch(o){if(console.error("Error loading jobs from sheets:",o),f)return console.log("Using cached job data due to error"),f;const s=E("mangpongJobs");if(s)try{const n=JSON.parse(s);return f=n,w=t,n}catch(n){console.error("Error parsing local jobs:",n)}return[]}}async function Y(){try{const e=await C({action:"getJobs",username:b.username});e&&e.success&&e.jobs&&(f=e.jobs,w=Date.now(),v("mangpongJobs",JSON.stringify(e.jobs)))}catch(e){console.warn("Background job refresh failed:",e)}}async function Q(e=!1){Swal.fire({title:"กำลังโหลดประวัติงาน...",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const t=await B(e);console.log("Loaded saved jobs:",t);const o=document.getElementById("job-history-container"),s=document.getElementById("no-jobs-message");if(o&&s){if(t.length===0){s.style.display="block",Swal.close();const a=document.getElementById("export-pdf-btn"),d=document.getElementById("export-pdf-btn-mobile");a&&(a.style.display="none"),d&&(d.style.display="none");return}s.style.display="none",t.sort((a,d)=>new Date(d.timestamp||0)-new Date(a.timestamp||0));const n=new Date;n.setDate(n.getDate()-30);const r=t.filter(a=>new Date(a.timestamp)>=n);if(o.querySelectorAll(".job-item").forEach(a=>a.remove()),r.length===0){s.style.display="block",s.querySelector("p:first-of-type").textContent="ไม่พบประวัติงานใน 30 วันล่าสุด",Swal.close();const a=document.getElementById("export-pdf-btn"),d=document.getElementById("export-pdf-btn-mobile");a&&(a.style.display="none"),d&&(d.style.display="none");return}r.forEach(a=>{const d=z(a);o.insertBefore(d,s)});const i=document.getElementById("export-pdf-btn"),l=document.getElementById("export-pdf-btn-mobile");i&&(i.style.display="block"),l&&(l.style.display="block")}Swal.close()}catch(t){Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:t.message,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function z(e){console.log("Creating job history item for job:",e);const t=document.createElement("div");t.className="card bg-white p-4 mb-4 job-item",t.setAttribute("data-status",e.status||"complete");const o=K(e.status),s=F(e.timestamp);return t.innerHTML=`
        <div class="flex justify-between items-start mb-1">
            <h3 class="font-medium">${e.jobId}</h3>
            <span class="px-2 py-1 text-xs rounded-full ${o.class}">${o.text}</span>
        </div>
        <div class="text-sm text-gray-600 mb-2">
            <p>วันที่: ${s}</p>
            <p>บริษัท: ${e.company||"ไม่ระบุ"}</p>
            <p>ผู้ติดต่อ: ${e.assignedBy||"ไม่ระบุ"}</p>
            <p>จำนวน: ${e.totalAmount?e.totalAmount.toFixed(2):"0.00"} บาท</p>
        </div>
        ${e.status==="incomplete"?`
            <div class="bg-red-50 border-l-4 border-red-500 p-2 text-sm text-red-700 mb-2">
                <p>เหตุผลไม่สมบูรณ์: ${e.incompleteReason||"ข้อมูลไม่ครบถ้วน"}</p>
            </div>
        `:""}
        ${e.status==="draft"?`
            <div class="bg-amber-50 border-l-4 border-amber-500 p-2 text-sm text-amber-700 mb-2">
                <p>สถานะ: บันทึกเป็นร่าง</p>
            </div>
        `:""}
        <div class="flex space-x-2">
          <button class="text-sm text-indigo-600 font-medium flex items-center touch-target" onclick="editJob('${e.jobId}')">
            ${e.status==="draft"?"แก้ไขร่าง":e.status==="incomplete"?"แก้ไขงานไม่สมบูรณ์":"แก้ไขงาน"}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
        </div>
    `,console.log("Created job element HTML:",t.innerHTML),console.log("Job element:",t),t}function K(e){switch(e){case"incomplete":return{class:"incomplete-badge",text:"ไม่สมบูรณ์"};case"draft":return{class:"draft-badge",text:"ร่าง"};default:return{class:"complete-badge",text:"สมบูรณ์"}}}async function W(){try{const e=await B(),t=new Date,o=t.toDateString(),s=e.filter(g=>new Date(g.timestamp).toDateString()===o).length,n=e.filter(g=>new Date(g.timestamp).toDateString()===o&&g.status==="complete").length,r=t.getMonth(),c=t.getFullYear(),i=e.filter(g=>{const h=new Date(g.timestamp);return h.getMonth()===r&&h.getFullYear()===c}).length,l=e.length,a=document.getElementById("jobs-today");a&&(a.textContent=s);const d=document.getElementById("completed-today");d&&(d.textContent=n);const p=document.getElementById("monthly-jobs");p&&(p.textContent=i+" งาน");const m=document.getElementById("total-jobs");m&&(m.textContent=l+" งาน");const y=document.getElementById("current-month");if(y){const g=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],h=t.getFullYear()+543;y.textContent=`${g[r]} ${h}`}}catch(e){console.error("Error updating stats:",e)}}function u(){V()||I("login-screen"),setInterval(T,6e4),window.addEventListener("online",function(){console.log("Online - processing request queue"),S.process()}),S.loadFromStorage();const e=document.getElementById("login-form");if(e){const o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.addEventListener("submit",async function(s){s.preventDefault();const{handleLogin:n}=await D(async()=>{const{handleLogin:r}=await import("./login-D6tg91Tp.js");return{handleLogin:r}},__vite__mapDeps([0,1]));await n(s)})}const t=document.getElementById("register-form");if(t){const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("submit",async function(s){s.preventDefault();const{handleRegister:n}=await D(async()=>{const{handleRegister:r}=await import("./register-CgE9XB9X.js");return{handleRegister:r}},__vite__mapDeps([2,1]));await n(s)})}}function V(){const e=E("mangpongUser");if(e)try{b=JSON.parse(e),console.log("Found logged in user:",b),I("app");const t=document.getElementById("user-display-name");return t&&(t.textContent=b.fullName||b.username),N(),!0}catch(t){console.error("Error parsing user data:",t),J("mangpongUser")}return!1}u.showPage=I;u.showScreen=x;u.logout=function(){b=null,J("mangpongUser"),J("mangpongJobs"),I("login-screen")};u.startNewJob=k;u.editJob=L;u.viewJob=U;u.cancelEdit=_;window.initializeApp=N;window.showPage=u.showPage;window.showScreen=u.showScreen;window.logout=u.logout;window.startNewJob=u.startNewJob;window.editJob=u.editJob;window.viewJob=u.viewJob;window.cancelEdit=u.cancelEdit;document.addEventListener("DOMContentLoaded",u);export{v as s};
