const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/login-Dd_QUZhA.js","assets/errors-D2UT2t2I.js","assets/register-C3DPrKGx.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=o(s);fetch(s.href,r)}})();const N="modulepreload",M=function(e){return"/"+e},A={},D=function(t,o,n){let s=Promise.resolve();if(o&&o.length>0){let g=function(i){return Promise.all(i.map(a=>Promise.resolve(a).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),d=c?.nonce||c?.getAttribute("nonce");s=g(o.map(i=>{if(i=M(i),i in A)return;A[i]=!0;const a=i.endsWith(".css"),l=a?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${i}"]${l}`))return;const m=document.createElement("link");if(m.rel=a?"stylesheet":N,a||(m.as="script"),m.crossOrigin="",m.href=i,d&&m.setAttribute("nonce",d),document.head.appendChild(m),a)return new Promise((y,b)=>{m.addEventListener("load",y),m.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${i}`)))})}))}function r(c){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=c,window.dispatchEvent(d),!d.defaultPrevented)throw c}return s.then(c=>{for(const d of c||[])d.status==="rejected"&&r(d.reason);return t().catch(r)})};function E(e,t){try{return localStorage.setItem(e,t),!0}catch(o){if(console.error("localStorage setItem failed:",o),R())try{const n=JSON.parse(S("mangpongJobs")||"[]");if(n.length>10){const s=n.slice(-10);return E("mangpongJobs",JSON.stringify(s)),E(e,t),!0}}catch(n){console.error("localStorage cleanup failed:",n)}return!1}}function S(e,t=null){try{return localStorage.getItem(e)||t}catch(o){return console.error("localStorage getItem failed:",o),t}}function L(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("localStorage removeItem failed:",t),!1}}function R(){return/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&navigator.maxTouchPoints>1}const I={requests:[],isProcessing:!1,add:function(e){this.requests.push({data:e,timestamp:Date.now(),attempts:0}),this.saveToStorage(),console.log("Request added to queue:",e)},process:async function(){if(!(this.isProcessing||this.requests.length===0||!navigator.onLine)){this.isProcessing=!0;try{for(;this.requests.length>0;){const e=this.requests[0];e.attempts++;try{console.log(`Processing queued request (attempt ${e.attempts}):`,e.data);const t=await C(e.data);this.requests.shift(),this.saveToStorage(),console.log("Queued request processed successfully")}catch(t){console.warn(`Queued request failed (attempt ${e.attempts}):`,t),e.attempts>=3?(console.error("Request failed after 3 attempts, removing from queue:",e.data),this.requests.shift(),this.saveToStorage()):await new Promise(o=>setTimeout(o,1e3*e.attempts))}}}finally{this.isProcessing=!1}}},saveToStorage:function(){try{E("mangpongRequestQueue",JSON.stringify(this.requests))}catch(e){console.error("Failed to save request queue to storage:",e)}},loadFromStorage:function(){try{const e=S("mangpongRequestQueue");e&&(this.requests=JSON.parse(e),console.log("Loaded request queue from storage:",this.requests))}catch(e){console.error("Failed to load request queue from storage:",e)}},clear:function(){this.requests=[],this.saveToStorage()}};function T(e){return navigator.onLine?F(e,3):(console.log("Offline - queuing request:",e),I.add(e),Promise.resolve({success:!0,message:"Request queued for later processing"}))}async function F(e,t=3){for(let o=1;o<=t;o++)try{return console.log(`Attempt ${o} to connect to Google Sheets`),await C(e)}catch(n){if(console.warn(`Attempt ${o} failed:`,n.message),o===t)return console.log("All attempts failed - queuing request for later:",e),I.add(e),{success:!0,message:"Request queued for later processing"};const s=Math.min(1e3*Math.pow(2,o-1),1e4);await new Promise(r=>setTimeout(r,s))}}async function C(e){if(!window.GOOGLE_SCRIPT_URL)throw new Error("Google Script URL ไม่ได้ถูกกำหนดไว้");try{const t=await fetch(window.GOOGLE_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return await t.json()}catch(t){throw new Error(`ไม่สามารถเชื่อมต่อกับ Google Apps Script ได้: ${t.message}`)}}function P(){const e=new Date,t=e.getFullYear()+543,o=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],s=["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"][e.getDay()],r=e.getDate(),c=o[e.getMonth()],d=t,g=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),a=`${s} ${r} ${c} ${d} ${g}:${i}`,l=document.getElementById("current-date-time");l&&(l.textContent=a);const m=`${c} ${d}`,y=document.getElementById("current-month");y&&(y.textContent=m);const b=document.getElementById("selected-date");b&&(b.value=$(e));const u=document.getElementById("job-date-picker");u&&(u.value=$(e))}function $(e){const t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${o}-${n}`}function k(e){const t=new Date(e),o=t.getFullYear()+543,n=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],s=t.getDate(),r=n[t.getMonth()];return`${s}/${r}/${o}`}let j="login-screen";function J(e){j=e,["login-screen","register-screen","app"].forEach(o=>{const n=document.getElementById(o);n?o===j?n.classList.remove("hidden"):n.classList.add("hidden"):console.warn(`Page element with ID '${o}' not found`)})}function B(e){const t=document.getElementById("home-screen"),o=document.getElementById("new-job-screen"),n=document.getElementById("history-screen");t&&t.classList.add("hidden"),o&&o.classList.add("hidden"),n&&n.classList.add("hidden");const s=document.getElementById(e);if(s&&s.classList.remove("hidden"),document.querySelectorAll(".nav-item").forEach(r=>{r.classList.remove("active")}),e==="home-screen"){const r=document.querySelectorAll(".nav-item")[0];r&&r.classList.add("active")}else if(e==="new-job-screen"){const r=document.querySelectorAll(".nav-item")[1];r&&r.classList.add("active");const c=document.getElementById("edit-job-id").value;c&&console.log("Entering edit mode for job:",c)}else if(e==="history-screen"){const r=document.querySelectorAll(".nav-item")[2];r&&r.classList.add("active")}}function _(){const e=document.getElementById("edit-job-id");e&&(e.value=""),B("new-job-screen")}function U(){const e=document.getElementById("edit-job-id");e&&(e.value=""),B("home-screen")}function x(e){try{if(!e)throw new Error("Job ID is required");}catch(t){console.error("Error editing job:",t),Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:`ไม่สามารถแก้ไขงานได้: ${t.message}`,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function G(e){}let h=null,p=null,v=0;const H=300*1e3;function O(){P(),Y(!0),V(),z(!0),document.querySelectorAll(".amount-input").forEach(e=>{e&&e.addEventListener("input",updateTotalAmount)}),setInterval(()=>{navigator.onLine&&Q()},300*1e3)}async function Y(e=!1){const t=await q(e),o=Array.isArray(t)?t:[],n=o.filter(i=>i&&i.status==="incomplete"),s=o.filter(i=>i&&i.status==="draft"),r=document.getElementById("incomplete-jobs-card"),c=document.getElementById("incomplete-jobs-list");r&&c&&(n.length>0?(r.classList.remove("hidden"),c.innerHTML="",n.forEach(i=>{if(i){const a=document.createElement("li");a.textContent=`${i.jobId}: ${i.incompleteReason||"ข้อมูลไม่ครบถ้วน"}`,a.className="cursor-pointer hover:text-indigo-600",a.onclick=function(){x(i.jobId)},c.appendChild(a)}})):r.classList.add("hidden"));const d=document.getElementById("draft-jobs-card"),g=document.getElementById("draft-jobs-list");d&&g&&(s.length>0?(d.classList.remove("hidden"),g.innerHTML="",s.forEach(i=>{if(i){const a=document.createElement("li");a.textContent=`${i.jobId}: ${i.company||"ไม่ระบุบริษัท"}`,a.className="cursor-pointer hover:text-indigo-600",a.onclick=function(){x(i.jobId)},g.appendChild(a)}})):d.classList.add("hidden"))}async function q(e=!1){const t=Date.now();if(!e&&p&&t-v<H)return console.log("Using cached job data"),p||[];if(!navigator.onLine&&p)return console.log("Using expired cached job data due to offline status"),p||[];try{console.log("Fetching fresh job data from Google Sheets");const o=await T({action:"getJobs",username:h?h.username:""});if(o&&o.success&&o.jobs){const n=Array.isArray(o.jobs)?o.jobs:[];return p=n,v=t,E("mangpongJobs",JSON.stringify(n)),n}else{if(p)return console.warn("API failed, using cached data"),p||[];const n=S("mangpongJobs");if(n)try{const s=JSON.parse(n),r=Array.isArray(s)?s:[];return p=r,v=t,r}catch(s){console.error("Error parsing local jobs:",s)}return[]}}catch(o){if(console.error("Error loading jobs from sheets:",o),p)return console.log("Using cached job data due to error"),p||[];const n=S("mangpongJobs");if(n)try{const s=JSON.parse(n),r=Array.isArray(s)?s:[];return p=r,v=t,r}catch(s){console.error("Error parsing local jobs:",s)}return[]}}async function Q(){try{if(!h||!h.username){console.warn("User not logged in, skipping background job refresh");return}const e=await T({action:"getJobs",username:h.username});if(e&&e.success&&e.jobs){const t=Array.isArray(e.jobs)?e.jobs:[];p=t,v=Date.now(),E("mangpongJobs",JSON.stringify(t))}}catch(e){console.warn("Background job refresh failed:",e)}}async function z(e=!1){Swal.fire({title:"กำลังโหลดประวัติงาน...",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const t=await q(e);console.log("Loaded saved jobs:",t);const o=document.getElementById("job-history-container"),n=document.getElementById("no-jobs-message");if(o&&n){const s=Array.isArray(t)?t:[];if(s.length===0){n.style.display="block",Swal.close();const a=document.getElementById("export-pdf-btn"),l=document.getElementById("export-pdf-btn-mobile");a&&(a.style.display="none"),l&&(l.style.display="none");return}n.style.display="none",s.sort((a,l)=>{const m=a&&a.timestamp?new Date(a.timestamp||0):new Date(0);return(l&&l.timestamp?new Date(l.timestamp||0):new Date(0))-m});const r=new Date;r.setDate(r.getDate()-30);const c=s.filter(a=>!a||!a.timestamp?!1:new Date(a.timestamp)>=r);if(o.querySelectorAll(".job-item").forEach(a=>a.remove()),c.length===0){n.style.display="block",n.querySelector("p:first-of-type").textContent="ไม่พบประวัติงานใน 30 วันล่าสุด",Swal.close();const a=document.getElementById("export-pdf-btn"),l=document.getElementById("export-pdf-btn-mobile");a&&(a.style.display="none"),l&&(l.style.display="none");return}c.forEach(a=>{if(a){const l=K(a);o.insertBefore(l,n)}});const g=document.getElementById("export-pdf-btn"),i=document.getElementById("export-pdf-btn-mobile");g&&(g.style.display="block"),i&&(i.style.display="block")}Swal.close()}catch(t){Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:t.message,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function K(e){if(console.log("Creating job history item for job:",e),!e)return console.error("Cannot create job history item: job is undefined"),document.createElement("div");const t=document.createElement("div");t.className="card bg-white p-4 mb-4 job-item",t.setAttribute("data-status",e.status||"complete");const o=W(e.status),n=e.timestamp?k(e.timestamp):"ไม่ระบุวันที่";return t.innerHTML=`
        <div class="flex justify-between items-start mb-1">
            <h3 class="font-medium">${e.jobId||"ไม่ระบุ ID"}</h3>
            <span class="px-2 py-1 text-xs rounded-full ${o.class}">${o.text}</span>
        </div>
        <div class="text-sm text-gray-600 mb-2">
            <p>วันที่: ${n}</p>
            <p>บริษัท: ${e.company||"ไม่ระบุ"}</p>
            <p>ผู้ติดต่อ: ${e.assignedBy||"ไม่ระบุ"}</p>
            <p>จำนวน: ${e.totalAmount?e.totalAmount.toFixed(2):"0.00"} บาท</p>
        </div>
        ${e.status==="incomplete"?`
            <div class="bg-red-50 border-l-4 border-red-500 p-2 text-sm text-red-700 mb-2">
                <p>เหตุผลไม่สมบูรณ์: ${e.incompleteReason||"ข้อมูลไม่ครบถ้วน"}</p>
            </div>
        `:""}
        ${e.status==="draft"?`
            <div class="bg-amber-50 border-l-4 border-amber-500 p-2 text-sm text-amber-700 mb-2">
                <p>สถานะ: บันทึกเป็นร่าง</p>
            </div>
        `:""}
        <div class="flex space-x-2">
          <button class="text-sm text-indigo-600 font-medium flex items-center touch-target" onclick="editJob('${e.jobId||""}')">
            ${e.status==="draft"?"แก้ไขร่าง":e.status==="incomplete"?"แก้ไขงานไม่สมบูรณ์":"แก้ไขงาน"}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
        </div>
    `,console.log("Created job element HTML:",t.innerHTML),console.log("Job element:",t),t}function W(e){switch(e){case"incomplete":return{class:"incomplete-badge",text:"ไม่สมบูรณ์"};case"draft":return{class:"draft-badge",text:"ร่าง"};default:return{class:"complete-badge",text:"สมบูรณ์"}}}async function V(){try{const e=await q(),t=Array.isArray(e)?e:[],o=new Date,n=o.toDateString(),s=t.filter(u=>!u||!u.timestamp?!1:new Date(u.timestamp).toDateString()===n).length,r=t.filter(u=>!u||!u.timestamp?!1:new Date(u.timestamp).toDateString()===n&&u.status==="complete").length,c=o.getMonth(),d=o.getFullYear(),g=t.filter(u=>{if(!u||!u.timestamp)return!1;const w=new Date(u.timestamp);return w.getMonth()===c&&w.getFullYear()===d}).length,i=t.length,a=document.getElementById("jobs-today");a&&(a.textContent=s);const l=document.getElementById("completed-today");l&&(l.textContent=r);const m=document.getElementById("monthly-jobs");m&&(m.textContent=g+" งาน");const y=document.getElementById("total-jobs");y&&(y.textContent=i+" งาน");const b=document.getElementById("current-month");if(b){const u=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],w=o.getFullYear()+543;b.textContent=`${u[c]} ${w}`}}catch(e){console.error("Error updating stats:",e)}}function f(){X()||J("login-screen"),setInterval(P,6e4),window.addEventListener("online",function(){console.log("Online - processing request queue"),I.process()}),I.loadFromStorage();const e=document.getElementById("login-form");if(e){const o=e.cloneNode(!0);e.parentNode.replaceChild(o,e),o.addEventListener("submit",async function(n){n.preventDefault();const{handleLogin:s}=await D(async()=>{const{handleLogin:r}=await import("./login-Dd_QUZhA.js");return{handleLogin:r}},__vite__mapDeps([0,1]));await s(n)})}const t=document.getElementById("register-form");if(t){const o=t.cloneNode(!0);t.parentNode.replaceChild(o,t),o.addEventListener("submit",async function(n){n.preventDefault();const{handleRegister:s}=await D(async()=>{const{handleRegister:r}=await import("./register-C3DPrKGx.js");return{handleRegister:r}},__vite__mapDeps([2,1]));await s(n)})}}function X(){const e=S("mangpongUser");if(e)try{h=JSON.parse(e),console.log("Found logged in user:",h),J("app");const t=document.getElementById("user-display-name");return t&&(t.textContent=h.fullName||h.username),O(),!0}catch(t){console.error("Error parsing user data:",t),L("mangpongUser")}return!1}f.showPage=J;f.showScreen=B;f.logout=function(){h=null,L("mangpongUser"),L("mangpongJobs"),J("login-screen")};f.startNewJob=_;f.editJob=x;f.viewJob=G;f.cancelEdit=U;window.initializeApp=O;window.showPage=f.showPage;window.showScreen=f.showScreen;window.logout=f.logout;window.startNewJob=f.startNewJob;window.editJob=f.editJob;window.viewJob=f.viewJob;window.cancelEdit=f.cancelEdit;document.addEventListener("DOMContentLoaded",f);export{D as _,E as s};
