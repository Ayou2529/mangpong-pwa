<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#3b82f6">
  <title>Mangpong Trading Delivery</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
  <!-- Google Fonts: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    html, body {
      font-family: 'Prompt', sans-serif;
      background: #f3f4f6;
      min-height: 100vh;
    }
    .swal2-popup {
      font-family: 'Prompt', sans-serif;
    }
    input, select, textarea {
      font-family: inherit;
    }
    .active-nav {
      color: #3b82f6 !important;
      font-weight: 700;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col bg-gray-100">
  <!-- App Container -->
  <div id="app" class="flex-1 flex flex-col max-w-md mx-auto w-full shadow-lg bg-white min-h-screen">
    <!-- Header -->
    <header class="bg-blue-500 text-white p-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <img src="icon-192.png" alt="Logo" class="w-8 h-8 rounded">
        <span class="font-bold text-lg">Mangpong Trading Delivery</span>
      </div>
      <button id="logoutBtn" class="hidden bg-white text-blue-500 px-3 py-1 rounded font-medium hover:bg-blue-100 transition">ออกจากระบบ</button>
    </header>
    <!-- Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto p-4 pb-20">
      <!-- Login/Register Page -->
      <section id="auth-section" class="max-w-sm mx-auto mt-8">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-2xl font-bold text-center mb-4 text-blue-500">เข้าสู่ระบบ</h2>
          <form id="loginForm" class="space-y-4">
            <input type="text" id="login-username" class="w-full border rounded px-3 py-2" placeholder="ชื่อผู้ใช้" required>
            <input type="password" id="login-password" class="w-full border rounded px-3 py-2" placeholder="รหัสผ่าน" required>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition">เข้าสู่ระบบ</button>
          </form>
          <div class="text-center mt-4">
            <button id="showRegisterBtn" class="text-blue-500 hover:underline">สมัครสมาชิก</button>
          </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mt-6 hidden" id="registerBox">
          <h2 class="text-2xl font-bold text-center mb-4 text-blue-500">สมัครสมาชิก</h2>
          <form id="registerForm" class="space-y-4">
            <input type="text" id="register-username" class="w-full border rounded px-3 py-2" placeholder="ชื่อผู้ใช้" required>
            <input type="password" id="register-password" class="w-full border rounded px-3 py-2" placeholder="รหัสผ่าน" required>
            <input type="text" id="register-name" class="w-full border rounded px-3 py-2" placeholder="ชื่อ-นามสกุล" required>
            <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition">สมัครสมาชิก</button>
          </form>
          <div class="text-center mt-4">
            <button id="showLoginBtn" class="text-blue-500 hover:underline">กลับเข้าสู่ระบบ</button>
          </div>
        </div>
      </section>
      <!-- Home Page -->
      <section id="home-section" class="hidden">
        <h2 class="text-xl font-bold text-blue-500 mb-4">สถิติประจำเดือน</h2>
        <div class="grid grid-cols-2 gap-4 mb-6">
          <div class="bg-blue-100 rounded p-4 text-center">
            <div class="text-2xl font-bold text-blue-600" id="stat-total">0</div>
            <div class="text-gray-700">งานทั้งหมด</div>
          </div>
          <div class="bg-green-100 rounded p-4 text-center">
            <div class="text-2xl font-bold text-green-600" id="stat-completed">0</div>
            <div class="text-gray-700">งานสำเร็จ</div>
          </div>
          <div class="bg-yellow-100 rounded p-4 text-center">
            <div class="text-2xl font-bold text-yellow-600" id="stat-pending">0</div>
            <div class="text-gray-700">รอดำเนินการ</div>
          </div>
          <div class="bg-red-100 rounded p-4 text-center">
            <div class="text-2xl font-bold text-red-600" id="stat-cancelled">0</div>
            <div class="text-gray-700">ยกเลิก</div>
          </div>
        </div>
        <div class="mb-6">
          <h3 class="font-bold text-lg mb-2">เมนูลัด</h3>
          <div class="flex gap-4">
            <button onclick="showSection('newjob-section')" class="flex-1 bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition">บันทึกงานใหม่</button>
            <button onclick="showSection('history-section')" class="flex-1 bg-gray-200 text-blue-500 py-2 rounded font-bold hover:bg-blue-100 transition">ประวัติงาน</button>
          </div>
        </div>
        <div>
          <h3 class="font-bold text-lg mb-2">รายงานประจำเดือน</h3>
          <div id="monthly-report" class="bg-gray-50 rounded p-4 text-gray-700 text-sm">
            <div class="text-center text-gray-400">ไม่มีข้อมูล</div>
          </div>
        </div>
      </section>
      <!-- New Job Page -->
      <section id="newjob-section" class="hidden">
        <h2 class="text-xl font-bold text-blue-500 mb-4">บันทึกงานใหม่</h2>
        <form id="newJobForm" class="space-y-4">
          <div>
            <label class="block font-medium mb-1">วันที่</label>
            <input type="date" id="job-date" class="w-full border rounded px-3 py-2" required>
          </div>
          <div>
            <label class="block font-medium mb-1">ชื่อลูกค้า</label>
            <input type="text" id="job-customer" class="w-full border rounded px-3 py-2" required>
          </div>
          <div>
            <label class="block font-medium mb-1">รายละเอียดงาน</label>
            <textarea id="job-detail" class="w-full border rounded px-3 py-2" rows="2" required></textarea>
          </div>
          <div>
            <label class="block font-medium mb-1">ค่าบริการหลัก (บาท)</label>
            <input type="number" id="job-mainfee" class="w-full border rounded px-3 py-2" min="0" value="0" required>
          </div>
          <div>
            <label class="block font-medium mb-1">ค่าบริการเพิ่มเติม (บาท)</label>
            <input type="number" id="job-addfee" class="w-full border rounded px-3 py-2" min="0" value="0">
          </div>
          <div>
            <label class="block font-medium mb-1">รวม (บาท)</label>
            <input type="number" id="job-totalfee" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
          </div>
          <div>
            <label class="block font-medium mb-1">สถานะ</label>
            <select id="job-status" class="w-full border rounded px-3 py-2" required>
              <option value="pending">รอดำเนินการ</option>
              <option value="completed">สำเร็จ</option>
              <option value="cancelled">ยกเลิก</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition">บันทึกงาน</button>
            <button type="button" id="saveDraftBtn" class="flex-1 bg-gray-200 text-blue-500 py-2 rounded font-bold hover:bg-blue-100 transition">บันทึกแบบร่าง</button>
          </div>
        </form>
      </section>
      <!-- History Page -->
      <section id="history-section" class="hidden">
        <h2 class="text-xl font-bold text-blue-500 mb-4">ประวัติงาน</h2>
        <div class="flex gap-2 mb-4">
          <input type="date" id="filter-date-from" class="border rounded px-2 py-1 flex-1" placeholder="จากวันที่">
          <input type="date" id="filter-date-to" class="border rounded px-2 py-1 flex-1" placeholder="ถึงวันที่">
          <select id="filter-status" class="border rounded px-2 py-1 flex-1">
            <option value="">ทุกสถานะ</option>
            <option value="pending">รอดำเนินการ</option>
            <option value="completed">สำเร็จ</option>
            <option value="cancelled">ยกเลิก</option>
          </select>
          <button id="filterBtn" class="bg-blue-500 text-white px-3 py-1 rounded font-bold hover:bg-blue-600 transition">ค้นหา</button>
        </div>
        <div id="history-list" class="space-y-3">
          <div class="text-center text-gray-400">ไม่มีข้อมูล</div>
        </div>
      </section>
      <!-- Edit Job Modal -->
      <div id="editJobModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md relative">
          <button id="closeEditModal" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-xl">&times;</button>
          <h2 class="text-xl font-bold text-blue-500 mb-4">แก้ไขงาน</h2>
          <form id="editJobForm" class="space-y-4">
            <input type="hidden" id="edit-job-id">
            <div>
              <label class="block font-medium mb-1">วันที่</label>
              <input type="date" id="edit-job-date" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
              <label class="block font-medium mb-1">ชื่อลูกค้า</label>
              <input type="text" id="edit-job-customer" class="w-full border rounded px-3 py-2" required>
            </div>
            <div>
              <label class="block font-medium mb-1">รายละเอียดงาน</label>
              <textarea id="edit-job-detail" class="w-full border rounded px-3 py-2" rows="2" required></textarea>
            </div>
            <div>
              <label class="block font-medium mb-1">ค่าบริการหลัก (บาท)</label>
              <input type="number" id="edit-job-mainfee" class="w-full border rounded px-3 py-2" min="0" value="0" required>
            </div>
            <div>
              <label class="block font-medium mb-1">ค่าบริการเพิ่มเติม (บาท)</label>
              <input type="number" id="edit-job-addfee" class="w-full border rounded px-3 py-2" min="0" value="0">
            </div>
            <div>
              <label class="block font-medium mb-1">รวม (บาท)</label>
              <input type="number" id="edit-job-totalfee" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
            </div>
            <div>
              <label class="block font-medium mb-1">สถานะ</label>
              <select id="edit-job-status" class="w-full border rounded px-3 py-2" required>
                <option value="pending">รอดำเนินการ</option>
                <option value="completed">สำเร็จ</option>
                <option value="cancelled">ยกเลิก</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded font-bold hover:bg-blue-600 transition">บันทึก</button>
              <button type="button" id="deleteJobBtn" class="flex-1 bg-red-500 text-white py-2 rounded font-bold hover:bg-red-600 transition">ลบงาน</button>
            </div>
          </form>
        </div>
      </div>
    </main>
    <!-- Bottom Navigation -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto w-full bg-white border-t flex justify-around py-2 z-40">
      <button class="flex flex-col items-center text-gray-500 hover:text-blue-500 transition" id="nav-home">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7m-9 2v6m0 0h6m-6 0v6m6-6v6m0 0h6m-6 0v6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-xs">หน้าหลัก</span>
      </button>
      <button class="flex flex-col items-center text-gray-500 hover:text-blue-500 transition" id="nav-newjob">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-xs">งานใหม่</span>
      </button>
      <button class="flex flex-col items-center text-gray-500 hover:text-blue-500 transition" id="nav-history">
        <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span class="text-xs">ประวัติ</span>
      </button>
    </nav>
  </div>
  <!-- Service Worker Registration & App Script -->
  <script>
    // --- PWA Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js')
          .then(function(reg) { /* success */ })
          .catch(function(err) { /* fail */ });
      });
    }

    // --- App State ---
    const GS_API = "https://script.google.com/macros/s/AKfycbwcOeN18ikAiLJN6un76LV2GIb_x2Xn4RHNZr-psa11xp8t4evXwKUOasfiF3RV9FPK/exec";
    let currentUser = null;
    let jobs = [];
    let drafts = [];
    let editingJobId = null;

    // --- DOM Elements ---
    const authSection = document.getElementById('auth-section');
    const homeSection = document.getElementById('home-section');
    const newjobSection = document.getElementById('newjob-section');
    const historySection = document.getElementById('history-section');
    const mainContent = document.getElementById('main-content');
    const bottomNav = document.getElementById('bottom-nav');
    const logoutBtn = document.getElementById('logoutBtn');
    const navHome = document.getElementById('nav-home');
    const navNewJob = document.getElementById('nav-newjob');
    const navHistory = document.getElementById('nav-history');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const registerBox = document.getElementById('registerBox');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const newJobForm = document.getElementById('newJobForm');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const historyList = document.getElementById('history-list');
    const filterBtn = document.getElementById('filterBtn');
    const filterDateFrom = document.getElementById('filter-date-from');
    const filterDateTo = document.getElementById('filter-date-to');
    const filterStatus = document.getElementById('filter-status');
    const statTotal = document.getElementById('stat-total');
    const statCompleted = document.getElementById('stat-completed');
    const statPending = document.getElementById('stat-pending');
    const statCancelled = document.getElementById('stat-cancelled');
    const monthlyReport = document.getElementById('monthly-report');
    // Edit Modal
    const editJobModal = document.getElementById('editJobModal');
    const closeEditModal = document.getElementById('closeEditModal');
    const editJobForm = document.getElementById('editJobForm');
    const deleteJobBtn = document.getElementById('deleteJobBtn');

    // --- Utility Functions ---
    function showSection(sectionId) {
      // Hide all
      [homeSection, newjobSection, historySection, authSection].forEach(s => s.classList.add('hidden'));
      // Show
      document.getElementById(sectionId).classList.remove('hidden');
      // Bottom nav highlight
      [navHome, navNewJob, navHistory].forEach(btn => btn.classList.remove('active-nav'));
      if (sectionId === 'home-section') navHome.classList.add('active-nav');
      if (sectionId === 'newjob-section') navNewJob.classList.add('active-nav');
      if (sectionId === 'history-section') navHistory.classList.add('active-nav');
      // Hide bottom nav on auth
      bottomNav.style.display = (sectionId === 'auth-section') ? 'none' : 'flex';
      logoutBtn.style.display = (sectionId === 'auth-section') ? 'none' : 'inline-block';
    }

    function showAlert(icon, title, text) {
      Swal.fire({icon, title, text, confirmButtonText: 'ตกลง'});
    }

    function saveLocal(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }
    function loadLocal(key, def=[]) {
      try {
        return JSON.parse(localStorage.getItem(key)) || def;
      } catch { return def; }
    }

    function formatDate(d) {
      if (!d) return '';
      const dt = new Date(d);
      return dt.toLocaleDateString('th-TH', {year:'numeric', month:'short', day:'numeric'});
    }

    function sum(a, b) {
      return (parseFloat(a) || 0) + (parseFloat(b) || 0);
    }

    // --- Auth Logic ---
    function setUser(user) {
      currentUser = user;
      if (user) {
        saveLocal('mptrading_user', user);
        showSection('home-section');
        fetchJobs();
      } else {
        localStorage.removeItem('mptrading_user');
        showSection('auth-section');
      }
    }

    function tryAutoLogin() {
      const user = loadLocal('mptrading_user', null);
      if (user) setUser(user);
      else showSection('auth-section');
    }

    loginForm.onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      if (!username || !password) return showAlert('warning', 'กรุณากรอกข้อมูล', '');
      // Call GS API for login
      try {
        const res = await fetch(GS_API + '?action=login', {
          method: 'POST',
          body: JSON.stringify({username, password}),
          headers: {'Content-Type':'application/json'}
        });
        const data = await res.json();
        if (data.status === 'success') {
          setUser(data.user);
          showAlert('success', 'เข้าสู่ระบบสำเร็จ', '');
        } else {
          showAlert('error', 'เข้าสู่ระบบล้มเหลว', data.message || '');
        }
      } catch {
        showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
      }
    };

    registerForm.onsubmit = async function(e) {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      const name = document.getElementById('register-name').value.trim();
      if (!username || !password || !name) return showAlert('warning', 'กรุณากรอกข้อมูล', '');
      // Call GS API for register
      try {
        const res = await fetch(GS_API + '?action=register', {
          method: 'POST',
          body: JSON.stringify({username, password, name}),
          headers: {'Content-Type':'application/json'}
        });
        const data = await res.json();
        if (data.status === 'success') {
          showAlert('success', 'สมัครสมาชิกสำเร็จ', 'เข้าสู่ระบบอัตโนมัติ');
          setUser(data.user);
        } else {
          showAlert('error', 'สมัครสมาชิกล้มเหลว', data.message || '');
        }
      } catch {
        showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
      }
    };

    logoutBtn.onclick = function() {
      Swal.fire({
        title: 'ออกจากระบบ?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ออกจากระบบ',
        cancelButtonText: 'ยกเลิก'
      }).then(res => {
        if (res.isConfirmed) setUser(null);
      });
    };

    showRegisterBtn.onclick = function() {
      registerBox.classList.remove('hidden');
      loginForm.parentElement.classList.add('hidden');
    };
    showLoginBtn.onclick = function() {
      registerBox.classList.add('hidden');
      loginForm.parentElement.classList.remove('hidden');
    };

    // --- Navigation ---
    navHome.onclick = () => showSection('home-section');
    navNewJob.onclick = () => showSection('newjob-section');
    navHistory.onclick = () => showSection('history-section');

    // --- Job Logic ---
    function fetchJobs() {
      // Call GS API to get jobs for current user
      fetch(GS_API + '?action=getJobs&username=' + encodeURIComponent(currentUser.username))
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            jobs = data.jobs || [];
            drafts = loadLocal('mptrading_drafts_' + currentUser.username, []);
            updateHomeStats();
            renderHistory();
            renderMonthlyReport();
          } else {
            jobs = [];
            updateHomeStats();
            renderHistory();
            renderMonthlyReport();
          }
        })
        .catch(() => {
          jobs = [];
          updateHomeStats();
          renderHistory();
          renderMonthlyReport();
        });
    }

    function updateHomeStats() {
      const month = (new Date()).getMonth()+1, year = (new Date()).getFullYear();
      const thisMonthJobs = jobs.filter(j => {
        const d = new Date(j.date);
        return d.getMonth()+1 === month && d.getFullYear() === year;
      });
      statTotal.textContent = thisMonthJobs.length;
      statCompleted.textContent = thisMonthJobs.filter(j=>j.status==='completed').length;
      statPending.textContent = thisMonthJobs.filter(j=>j.status==='pending').length;
      statCancelled.textContent = thisMonthJobs.filter(j=>j.status==='cancelled').length;
    }

    function renderMonthlyReport() {
      const month = (new Date()).getMonth()+1, year = (new Date()).getFullYear();
      const thisMonthJobs = jobs.filter(j => {
        const d = new Date(j.date);
        return d.getMonth()+1 === month && d.getFullYear() === year;
      });
      if (!thisMonthJobs.length) {
        monthlyReport.innerHTML = '<div class="text-center text-gray-400">ไม่มีข้อมูล</div>';
        return;
      }
      let total = 0, completed = 0, pending = 0, cancelled = 0, sumFee = 0;
      thisMonthJobs.forEach(j => {
        total++;
        if (j.status === 'completed') completed++;
        if (j.status === 'pending') pending++;
        if (j.status === 'cancelled') cancelled++;
        sumFee += sum(j.mainfee, j.addfee);
      });
      monthlyReport.innerHTML = `
        <div>งานทั้งหมด: <span class="font-bold">${total}</span></div>
        <div>สำเร็จ: <span class="font-bold text-green-600">${completed}</span></div>
        <div>รอดำเนินการ: <span class="font-bold text-yellow-600">${pending}</span></div>
        <div>ยกเลิก: <span class="font-bold text-red-600">${cancelled}</span></div>
        <div>รายได้รวม: <span class="font-bold text-blue-600">${sumFee.toLocaleString()} บาท</span></div>
      `;
    }

    // --- New Job Form ---
    function updateJobTotalFee() {
      const main = document.getElementById('job-mainfee').value;
      const add = document.getElementById('job-addfee').value;
      document.getElementById('job-totalfee').value = sum(main, add);
    }
    document.getElementById('job-mainfee').oninput = updateJobTotalFee;
    document.getElementById('job-addfee').oninput = updateJobTotalFee;

    newJobForm.onsubmit = async function(e) {
      e.preventDefault();
      const job = {
        date: document.getElementById('job-date').value,
        customer: document.getElementById('job-customer').value.trim(),
        detail: document.getElementById('job-detail').value.trim(),
        mainfee: parseFloat(document.getElementById('job-mainfee').value) || 0,
        addfee: parseFloat(document.getElementById('job-addfee').value) || 0,
        status: document.getElementById('job-status').value,
        username: currentUser.username
      };
      if (!job.date || !job.customer || !job.detail) {
        return showAlert('warning', 'กรุณากรอกข้อมูลให้ครบ', '');
      }
      // Call GS API to save job
      try {
        const res = await fetch(GS_API + '?action=addJob', {
          method: 'POST',
          body: JSON.stringify(job),
          headers: {'Content-Type':'application/json'}
        });
        const data = await res.json();
        if (data.status === 'success') {
          showAlert('success', 'บันทึกงานสำเร็จ', '');
          newJobForm.reset();
          updateJobTotalFee();
          fetchJobs();
          showSection('history-section');
        } else {
          showAlert('error', 'บันทึกงานล้มเหลว', data.message || '');
        }
      } catch {
        showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
      }
    };

    saveDraftBtn.onclick = function() {
      const job = {
        date: document.getElementById('job-date').value,
        customer: document.getElementById('job-customer').value.trim(),
        detail: document.getElementById('job-detail').value.trim(),
        mainfee: parseFloat(document.getElementById('job-mainfee').value) || 0,
        addfee: parseFloat(document.getElementById('job-addfee').value) || 0,
        status: document.getElementById('job-status').value,
        username: currentUser.username,
        draft: true,
        id: Date.now()
      };
      drafts.push(job);
      saveLocal('mptrading_drafts_' + currentUser.username, drafts);
      showAlert('success', 'บันทึกแบบร่างสำเร็จ', '');
      newJobForm.reset();
      updateJobTotalFee();
    };

    // --- History ---
    function renderHistory() {
      let list = jobs.slice();
      // Filter
      const from = filterDateFrom.value, to = filterDateTo.value, status = filterStatus.value;
      if (from) list = list.filter(j => j.date >= from);
      if (to) list = list.filter(j => j.date <= to);
      if (status) list = list.filter(j => j.status === status);
      if (!list.length) {
        historyList.innerHTML = '<div class="text-center text-gray-400">ไม่มีข้อมูล</div>';
        return;
      }
      historyList.innerHTML = '';
      list.sort((a,b)=>b.date.localeCompare(a.date));
      list.forEach(j => {
        const color = j.status === 'completed' ? 'green' : j.status === 'pending' ? 'yellow' : 'red';
        const statusText = j.status === 'completed' ? 'สำเร็จ' : j.status === 'pending' ? 'รอดำเนินการ' : 'ยกเลิก';
        const el = document.createElement('div');
        el.className = 'bg-white rounded shadow p-3 flex flex-col gap-1 border-l-4 border-' + color + '-500';
        el.innerHTML = `
          <div class="flex justify-between items-center">
            <div class="font-bold text-blue-600">${j.customer}</div>
            <div class="text-xs text-gray-400">${formatDate(j.date)}</div>
          </div>
          <div class="text-gray-700">${j.detail}</div>
          <div class="flex justify-between items-center text-sm">
            <div>ค่าบริการ: <span class="font-bold text-blue-500">${sum(j.mainfee, j.addfee).toLocaleString()} บาท</span></div>
            <div class="text-${color}-600 font-bold">${statusText}</div>
          </div>
          <div class="flex justify-end">
            <button class="text-blue-500 hover:underline text-xs" onclick="openEditJobModal('${j.id}')">แก้ไข</button>
          </div>
        `;
        historyList.appendChild(el);
      });
    }

    filterBtn.onclick = renderHistory;
    filterDateFrom.onchange = renderHistory;
    filterDateTo.onchange = renderHistory;
    filterStatus.onchange = renderHistory;

    // --- Edit Job Modal ---
    window.openEditJobModal = function(id) {
      const job = jobs.find(j=>j.id==id);
      if (!job) return;
      editingJobId = id;
      document.getElementById('edit-job-id').value = job.id;
      document.getElementById('edit-job-date').value = job.date;
      document.getElementById('edit-job-customer').value = job.customer;
      document.getElementById('edit-job-detail').value = job.detail;
      document.getElementById('edit-job-mainfee').value = job.mainfee;
      document.getElementById('edit-job-addfee').value = job.addfee;
      document.getElementById('edit-job-totalfee').value = sum(job.mainfee, job.addfee);
      document.getElementById('edit-job-status').value = job.status;
      editJobModal.classList.remove('hidden');
    };
    closeEditModal.onclick = function() {
      editJobModal.classList.add('hidden');
      editingJobId = null;
    };
    document.getElementById('edit-job-mainfee').oninput = function() {
      document.getElementById('edit-job-totalfee').value = sum(
        document.getElementById('edit-job-mainfee').value,
        document.getElementById('edit-job-addfee').value
      );
    };
    document.getElementById('edit-job-addfee').oninput = function() {
      document.getElementById('edit-job-totalfee').value = sum(
        document.getElementById('edit-job-mainfee').value,
        document.getElementById('edit-job-addfee').value
      );
    };
    editJobForm.onsubmit = async function(e) {
      e.preventDefault();
      const job = {
        id: document.getElementById('edit-job-id').value,
        date: document.getElementById('edit-job-date').value,
        customer: document.getElementById('edit-job-customer').value.trim(),
        detail: document.getElementById('edit-job-detail').value.trim(),
        mainfee: parseFloat(document.getElementById('edit-job-mainfee').value) || 0,
        addfee: parseFloat(document.getElementById('edit-job-addfee').value) || 0,
        status: document.getElementById('edit-job-status').value,
        username: currentUser.username
      };
      if (!job.date || !job.customer || !job.detail) {
        return showAlert('warning', 'กรุณากรอกข้อมูลให้ครบ', '');
      }
      // Call GS API to update job
      try {
        const res = await fetch(GS_API + '?action=editJob', {
          method: 'POST',
          body: JSON.stringify(job),
          headers: {'Content-Type':'application/json'}
        });
        const data = await res.json();
        if (data.status === 'success') {
          showAlert('success', 'แก้ไขงานสำเร็จ', '');
          editJobModal.classList.add('hidden');
          fetchJobs();
        } else {
          showAlert('error', 'แก้ไขงานล้มเหลว', data.message || '');
        }
      } catch {
        showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
      }
    };
    deleteJobBtn.onclick = async function() {
      Swal.fire({
        title: 'ลบงานนี้?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ลบ',
        cancelButtonText: 'ยกเลิก'
      }).then(async res => {
        if (res.isConfirmed) {
          // Call GS API to delete job
          try {
            const res = await fetch(GS_API + '?action=deleteJob', {
              method: 'POST',
              body: JSON.stringify({id: editingJobId, username: currentUser.username}),
              headers: {'Content-Type':'application/json'}
            });
            const data = await res.json();
            if (data.status === 'success') {
              showAlert('success', 'ลบงานสำเร็จ', '');
              editJobModal.classList.add('hidden');
              fetchJobs();
            } else {
              showAlert('error', 'ลบงานล้มเหลว', data.message || '');
            }
          } catch {
            showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์');
          }
        }
      });
    };

    // --- On Load ---
    tryAutoLogin();
    updateJobTotalFee();

    // --- Responsive Fix for iOS Safari Bottom Nav ---
    function fixBottomNav() {
      const nav = document.getElementById('bottom-nav');
      if (window.innerWidth > 500) nav.style.position = 'static';
      else nav.style.position = 'fixed';
    }
    window.addEventListener('resize', fixBottomNav);
    fixBottomNav();
  </script>
</body>
</html>
