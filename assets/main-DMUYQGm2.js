(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(a){if(a.ep)return;a.ep=!0;const i=r(a);fetch(a.href,i)}})();let h=null;function E(e,t){try{return localStorage.setItem(e,t),!0}catch{if($())try{const o=JSON.parse(S("mangpongJobs")||"[]");if(o.length>10){const a=o.slice(-10);return E("mangpongJobs",JSON.stringify(a)),E(e,t),!0}}catch(o){console.error("localStorage cleanup failed:",o)}return!1}}function S(e,t=null){try{return localStorage.getItem(e)||t}catch(r){return console.error("localStorage getItem failed:",r),t}}function W(e){try{return localStorage.removeItem(e),!0}catch(t){return console.error("localStorage removeItem failed:",t),!1}}let O="login-screen";function I(e){O=e,["login-screen","register-screen","app"].forEach(r=>{const o=document.getElementById(r);o?r===O?o.classList.remove("hidden"):o.classList.add("hidden"):console.warn(`Page element with ID '${r}' not found`)})}async function q(e=!1){try{if(!h)return console.warn("No current user, returning empty array"),[];if(!window.GOOGLE_SCRIPT_URL)return console.warn("Google Script URL not defined, using localStorage only"),JSON.parse(S("mangpongJobs")||"[]");if(!navigator.onLine)return console.log("Offline mode: Using localStorage only"),JSON.parse(S("mangpongJobs")||"[]");if(e){console.log("Force refresh requested, loading from network");try{const s=await x({action:"getJobs",username:h.username});if(s.success&&s.jobs)return E("mangpongJobs",JSON.stringify(s.jobs)),E("mangpongJobsLastUpdate",Date.now().toString()),s.jobs;throw new Error("Failed to load jobs from sheets")}catch(s){return console.warn("Failed to load jobs from network, falling back to localStorage",s.message),JSON.parse(S("mangpongJobs")||"[]")}}const t=S("mangpongJobsLastUpdate"),r=Date.now()-5*60*1e3;if(t&&parseInt(t)>r){const s=JSON.parse(S("mangpongJobs")||"[]");return console.log("Using recently cached data"),G(),s}const o=Promise.resolve(JSON.parse(S("mangpongJobs")||"[]")),a=new Promise(async(s,l)=>{try{const d=await x({action:"getJobs",username:h.username});d.success&&d.jobs?(E("mangpongJobs",JSON.stringify(d.jobs)),E("mangpongJobsLastUpdate",Date.now().toString()),s(d.jobs)):l(new Error("Failed to load jobs from sheets"))}catch(d){l(d)}}),i=new Promise((s,l)=>setTimeout(()=>l(new Error("Network timeout")),15e3)),n=Promise.race([a,i]);try{return await n}catch(s){return console.warn("Failed to load jobs from sheets, falling back to localStorage",s.message),await o}}catch(t){return console.error("Error loading jobs:",t),JSON.parse(S("mangpongJobs")||"[]")}}async function G(){try{if(!navigator.onLine)return;console.log("Loading jobs in background");const e=await x({action:"getJobs",username:h.username});e.success&&e.jobs&&(E("mangpongJobs",JSON.stringify(e.jobs)),E("mangpongJobsLastUpdate",Date.now().toString()),console.log("Background job loading completed"))}catch(e){console.warn("Background job loading failed:",e.message)}}const A=document.getElementById("login-form");A&&A.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("login-username"),r=document.getElementById("login-password");if(!t||!r){await Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:"ไม่พบองค์ประกอบฟอร์มที่จำเป็น",confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"});return}const o=t.value.trim(),a=r.value.trim();if(!o||!a){await Swal.fire({icon:"warning",title:"กรุณากรอกข้อมูล",text:"กรุณากรอกชื่อผู้ใช้และรหัสผ่าน",confirmButtonText:"ตกลง",confirmButtonColor:"#f59e0b"});return}console.log("Attempting login for user:",o),Swal.fire({title:"กำลังเข้าสู่ระบบ...",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const i=new Promise((d,c)=>setTimeout(()=>c(new Error("การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง")),15e3)),n={action:"login",username:o,password:a};console.log("Sending login request:",n);const s=x(n),l=await Promise.race([s,i]);if(console.log("Received login response:",l),l&&l.success){h=l.user,E("mangpongUser",JSON.stringify(h)),await Swal.fire({icon:"success",title:"เข้าสู่ระบบสำเร็จ!",text:`ยินดีต้อนรับ ${h.fullName||o}`,confirmButtonText:"ตกลง",confirmButtonColor:"#10b981"}),I("app");const d=document.getElementById("user-display-name");d&&(d.textContent=h.fullName||o),Y()}else await Swal.fire({icon:"error",title:"เข้าสู่ระบบไม่สำเร็จ",text:l&&l.error?l.error:"ข้อมูลการเข้าสู่ระบบไม่ถูกต้อง",confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}catch(i){console.error("Login error:",i);let n="ไม่สามารถเชื่อมต่อได้",s="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ ระบบจะใช้ข้อมูลออฟไลน์แทน";i.message&&i.message.includes("หมดเวลา")?(n="การเชื่อมต่อใช้เวลานานเกินไป",s="การเชื่อมต่อกับเซิร์ฟเวอร์ใช้เวลานานเกินไป โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):i.message&&i.message.includes("ไม่สามารถเชื่อมต่อ")&&(n="ไม่สามารถเชื่อมต่อได้",s="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"),await Swal.fire({icon:"error",title:n,text:s,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}});const j=document.getElementById("register-form");j&&j.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("register-username"),r=document.getElementById("register-password"),o=document.getElementById("register-confirm-password"),a=document.getElementById("register-fullname"),i=document.getElementById("register-phone"),n=document.getElementById("register-email");if(!t||!r||!o||!a||!i||!n){await Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:"ไม่พบองค์ประกอบฟอร์มที่จำเป็น",confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"});return}const s=t.value.trim(),l=r.value.trim(),d=o.value.trim(),c=a.value.trim(),p=i.value.trim(),g=n.value.trim();if(!s||!l||!d||!c||!p||!g){await Swal.fire({icon:"warning",title:"กรุณากรอกข้อมูลให้ครบ",text:"กรุณากรอกข้อมูลทุกช่อง",confirmButtonText:"ตกลง",confirmButtonColor:"#f59e0b"});return}if(l!==d){await Swal.fire({icon:"error",title:"รหัสผ่านไม่ตรงกัน",text:"กรุณาตรวจสอบรหัสผ่านและยืนยันรหัสผ่านให้ตรงกัน",confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"});return}Swal.fire({title:"กำลังสมัครสมาชิก...",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const b=new Promise((m,f)=>setTimeout(()=>f(new Error("การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง")),15e3)),y=x({action:"register",username:s,password:l,fullName:c,phone:p,email:g}),u=await Promise.race([y,b]);u&&u.success?(await Swal.fire({icon:"success",title:"สมัครสมาชิกสำเร็จ!",text:"คุณสามารถเข้าสู่ระบบได้แล้ว",confirmButtonText:"ตกลง",confirmButtonColor:"#10b981"}),j.reset(),I("login-screen")):await Swal.fire({icon:"error",title:"สมัครสมาชิกไม่สำเร็จ",text:u&&u.error?u.error:"ไม่สามารถสมัครสมาชิกได้ กรุณาลองใหม่อีกครั้ง",confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}catch(b){console.error("Registration error:",b);let y="ไม่สามารถเชื่อมต่อได้",u="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ ระบบจะใช้ข้อมูลออฟไลน์แทน";b.message&&b.message.includes("หมดเวลา")?(y="การเชื่อมต่อใช้เวลานานเกินไป",u="การเชื่อมต่อกับเซิร์ฟเวอร์ใช้เวลานานเกินไป โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):b.message&&b.message.includes("ไม่สามารถเชื่อมต่อ")&&(y="ไม่สามารถเชื่อมต่อได้",u="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"),await Swal.fire({icon:"error",title:y,text:u,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}});function x(e){return Q(e,2)}async function Q(e,t=2){for(let r=1;r<=t;r++)try{return console.log(`Attempt ${r} to connect to Google Sheets`),await X(e)}catch(o){if(console.warn(`Attempt ${r} failed:`,o.message),r===t)throw o;await new Promise(a=>setTimeout(a,500))}}function X(e){return new Promise((t,r)=>{if(!window.GOOGLE_SCRIPT_URL){r(new Error("Google Script URL ไม่ได้ถูกกำหนดไว้"));return}const o="jsonpCallback_"+Date.now();window[o]=l=>{t(l),s()};const a=new URLSearchParams({...e,callback:o}).toString(),i=document.createElement("script");i.src=`${window.GOOGLE_SCRIPT_URL}?${a}`,i.onerror=()=>{r(new Error("ไม่สามารถเชื่อมต่อกับ Google Apps Script ได้")),s()};const n=setTimeout(()=>{r(new Error("การเชื่อมต่อกับ Google Apps Script หมดเวลา")),s()},3e4);function s(){clearTimeout(n),delete window[o],i.parentNode&&i.parentNode.removeChild(i)}document.body.appendChild(i)})}function Y(){Z(),z(!0),B(!0),V(!0),document.querySelectorAll(".amount-input").forEach(e=>{e.addEventListener("input",w)}),setInterval(()=>{navigator.onLine&&G()},5*60*1e3)}function Z(){const e=new Date,t=e.getFullYear()+543,r=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],a=["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"][e.getDay()],i=e.getDate(),n=r[e.getMonth()],s=t,l=String(e.getHours()).padStart(2,"0"),d=String(e.getMinutes()).padStart(2,"0"),c=`${a} ${i} ${n} ${s} ${l}:${d}`,p=document.getElementById("current-date-time");p&&(p.textContent=c);const g=`${n} ${s}`,b=document.getElementById("current-month");b&&(b.textContent=g);const y=document.getElementById("selected-date");y&&(y.value=C(e));const u=document.getElementById("job-date-picker");u&&(u.value=C(e))}function ee(e){const t=String(e.getDate()).padStart(2,"0"),r=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear()+543;return`${t}/${r}/${o}`}function C(e){const t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${o}`}function _(e){const t=new Date(e),r=t.getFullYear()+543,o=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],a=t.getDate(),i=o[t.getMonth()];return`${a}/${i}/${r}`}async function z(e=!1){const t=await q(e),r=t.filter(l=>l.status==="incomplete"),o=t.filter(l=>l.status==="draft"),a=document.getElementById("incomplete-jobs-card"),i=document.getElementById("incomplete-jobs-list");a&&i&&(r.length>0?(a.classList.remove("hidden"),i.innerHTML="",r.forEach(l=>{const d=document.createElement("li");d.textContent=`${l.jobId}: ${l.incompleteReason||"ข้อมูลไม่ครบถ้วน"}`,d.className="cursor-pointer hover:text-indigo-600",d.onclick=function(){k(l.jobId)},i.appendChild(d)})):a.classList.add("hidden"));const n=document.getElementById("draft-jobs-card"),s=document.getElementById("draft-jobs-list");n&&s&&(o.length>0?(n.classList.remove("hidden"),s.innerHTML="",o.forEach(l=>{const d=document.createElement("li");d.textContent=`${l.jobId}: ${l.company||"ไม่ระบุบริษัท"}`,d.className="cursor-pointer hover:text-indigo-600",d.onclick=function(){k(l.jobId)},s.appendChild(d)})):n.classList.add("hidden"))}function D(e){const t=document.getElementById("home-screen"),r=document.getElementById("new-job-screen"),o=document.getElementById("history-screen");t&&t.classList.add("hidden"),r&&r.classList.add("hidden"),o&&o.classList.add("hidden");const a=document.getElementById(e);if(a&&a.classList.remove("hidden"),document.querySelectorAll(".nav-item").forEach(i=>{i.classList.remove("active")}),e==="home-screen"){const i=document.querySelectorAll(".nav-item")[0];i&&i.classList.add("active"),z(),B()}else if(e==="new-job-screen"){const i=document.querySelectorAll(".nav-item")[1];i&&i.classList.add("active");const n=document.getElementById("edit-job-id").value;n?console.log("Entering edit mode for job:",n):L()}else if(e==="history-screen"){const i=document.querySelectorAll(".nav-item")[2];i&&i.classList.add("active"),V()}}const N=document.getElementById("add-job-detail");N&&N.addEventListener("click",function(){const e=document.getElementById("job-details-container"),t=e.querySelectorAll(".job-detail-card").length;if(t<5){const r=document.createElement("div");r.className="job-detail-card border border-gray-200 rounded-md p-3 mb-3",r.innerHTML=`
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">รายละเอียดงาน #${t+1}</h3>
                    <button type="button" class="text-red-500 remove-job-detail touch-target">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">บริษัทปลายทาง</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อบริษัทปลายทาง" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">จังหวัดส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="จังหวัดส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">เขต/อำเภอส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="เขต/อำเภอส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">ผู้รับงาน</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อผู้รับงาน" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">รายละเอียด</label>
                    <textarea class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="รายละเอียดงาน" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-gray-600 mb-1">จำนวนเงิน - บาท</label>
                    <input type="number" class="w-full p-3 border border-gray-300 rounded-md amount-input touch-target" placeholder="0.00" min="0" step="0.01" required>
                </div>
            `,e.appendChild(r),r.querySelector(".remove-job-detail").addEventListener("click",function(){e.removeChild(r),w()}),r.querySelector(".amount-input").addEventListener("input",w)}else Swal.fire({icon:"warning",title:"จำกัดจำนวนรายการ",text:"คุณสามารถเพิ่มรายละเอียดงานได้สูงสุด 5 รายการ",confirmButtonText:"ตกลง",confirmButtonColor:"#f59e0b"})});const P=document.getElementById("add-fee");P&&P.addEventListener("click",function(){const e=document.getElementById("additional-fees-container"),t=document.createElement("div");t.className="flex justify-between items-center mb-2",t.innerHTML=`
            <div class="flex-1 mr-2">
                <select class="w-full p-3 border border-gray-300 rounded-md touch-target" required>
                    <option value="" disabled selected>เลือกรายการ</option>
                    <option value="บรรทุก">บรรทุก</option>
                    <option value="ล่วงเวลา_OT">ล่วงเวลา_OT</option>
                    <option value="กลับ">กลับ</option>
                    <option value="รอ">รอ</option>
                </select>
            </div>
            <div class="w-24 mr-2">
                <input type="number" class="w-full p-3 border border-gray-300 rounded-md fee-amount touch-target" placeholder="0.00" min="0" step="0.01" required>
            </div>
            <button type="button" class="text-red-500 remove-fee touch-target">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        `,e.appendChild(t),t.querySelector(".remove-fee").addEventListener("click",function(){e.removeChild(t),w()}),t.querySelector(".fee-amount").addEventListener("input",w)});function w(){try{let e=0,t=0;const r=document.querySelectorAll(".amount-input");for(let n=0;n<r.length;n++){const s=parseFloat(r[n].value)||0;t+=s,e+=s}const o=document.getElementById("main-service-fee");o&&(o.textContent=t.toFixed(2)+" บาท");const a=document.querySelectorAll(".fee-amount");for(let n=0;n<a.length;n++){const s=parseFloat(a[n].value)||0;e+=s}const i=document.getElementById("total-amount");i&&(i.textContent=e.toFixed(2)+" บาท")}catch(e){console.error("Error updating total amount:",e)}}const M=document.getElementById("floating-save-btn");M&&M.addEventListener("click",async function(){Swal.fire({title:"กำลังบันทึกร่าง...",text:"กรุณารอสักครู่",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const e=T();e.status="draft",await F(e,!0),await Swal.fire({icon:"info",title:"บันทึกร่างสำเร็จ!",text:`งาน ${e.jobId} ถูกบันทึกเป็นร่างแล้ว`,confirmButtonText:"ตกลง",confirmButtonColor:"#3b82f6"}),B();const t=[{id:e.jobId,company:e.company||"แมงป่อง เทรดดิ้ง"}],r=document.getElementById("draft-jobs-card"),o=document.getElementById("draft-jobs-list");r.classList.remove("hidden"),o.innerHTML="",t.forEach(a=>{const i=document.createElement("li");i.textContent=`${a.id}: ${a.company}`,i.className="cursor-pointer hover:text-indigo-600",i.onclick=function(){k(a.id)},o.appendChild(i)}),L(),D("home-screen")}catch(e){console.error("Error saving draft:",e),await Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด!",text:e.message,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}});function T(){try{const e=document.getElementById("new-job-form");if(!e)throw new Error("Form not found - new-job-form element missing");const t=te(e);if(t.length>0)throw new Error(`กรุณาตรวจสอบข้อมูลในฟอร์ม:
${t.join(`
`)}`);const r=document.getElementById("job-date-picker");if(!r)throw new Error("Job date picker not found");let o,a;const i=document.getElementById("edit-job-id").value,n=document.getElementById("original-job-date");if(i&&n&&n.value){const m=n.value;o=K(m),a=m}else o=new Date(r.value),a=ee(o);const s={timestamp:o.toISOString(),jobDate:a,jobId:i||"JOB-"+Math.floor(1e4+Math.random()*9e4),username:h?h.username:"unknown",company:e.querySelector("select")?e.querySelector("select").value:"",assignedBy:e.querySelector('input[placeholder="ชื่อผู้มอบงาน"]')?e.querySelector('input[placeholder="ชื่อผู้มอบงาน"]').value:"",contact:e.querySelector('input[placeholder="ข้อมูลติดต่อ"]')?e.querySelector('input[placeholder="ข้อมูลติดต่อ"]').value:"",pickupProvince:e.querySelector('input[placeholder="จังหวัด"]')?e.querySelector('input[placeholder="จังหวัด"]').value:"",pickupDistrict:e.querySelector('input[placeholder="เขต/อำเภอ"]')?e.querySelector('input[placeholder="เขต/อำเภอ"]').value:""},l=[];document.querySelectorAll(".job-detail-card").forEach(m=>{const f=m.querySelectorAll("input, textarea");l.push({destinationCompany:f[0]?f[0].value:"",deliveryProvince:f[1]?f[1].value:"",deliveryDistrict:f[2]?f[2].value:"",recipient:f[3]?f[3].value:"",description:f[4]?f[4].value:"",amount:f[5]&&parseFloat(f[5].value)||0})});const c=[];document.querySelectorAll("#additional-fees-container > div").forEach(m=>{const f=m.querySelector("select"),v=m.querySelector("input");f&&v&&c.push({description:f.value,amount:parseFloat(v.value)||0})});const g=l.reduce((m,f)=>m+(parseFloat(f.amount)||0),0),b=c.reduce((m,f)=>m+(parseFloat(f.amount)||0),0),y=g+b,u={};return l.forEach((m,f)=>{const v=f+1;u["companyTo"+v]=m.destinationCompany||"",u["province"+v]=m.deliveryProvince||"",u["district"+v]=m.deliveryDistrict||"",u["recipient"+v]=m.recipient||"",u["detail"+v]=m.description||"",u["amount"+v]=parseFloat(m.amount)||0}),u.jobCount=l.length,c.forEach((m,f)=>{const v=f+1;u["feeName"+v]=m.description||"",u["feeAmount"+v]=parseFloat(m.amount)||0}),u.feeCount=c.length,{...s,jobDetails:JSON.stringify(l),additionalFees:JSON.stringify(c),mainServiceFee:g,additionalFeesTotal:b,totalAmount:y,...u}}catch(e){throw console.error("Error collecting form data:",e),new Error(`Failed to collect form data: ${e.message}`)}}function te(e){const t=[],r=e.querySelector("select");(!r||!r.value)&&t.push("กรุณาเลือกบริษัท/สถานที่รับงาน");const o=e.querySelector('input[placeholder="ชื่อผู้มอบงาน"]');(!o||!o.value.trim())&&t.push("กรุณากรอกชื่อผู้มอบงาน");const a=e.querySelector('input[placeholder="ข้อมูลติดต่อ"]');(!a||!a.value.trim())&&t.push("กรุณากรอกข้อมูลติดต่อ");const i=e.querySelector('input[placeholder="จังหวัด"]');(!i||!i.value.trim())&&t.push("กรุณากรอกจังหวัดรับของ");const n=e.querySelector('input[placeholder="เขต/อำเภอ"]');(!n||!n.value.trim())&&t.push("กรุณากรอกเขต/อำเภอรับของ");const s=document.querySelectorAll(".job-detail-card");return s.length===0?t.push("กรุณาเพิ่มรายละเอียดงานอย่างน้อย 1 รายการ"):s.forEach((d,c)=>{const p=d.querySelectorAll("input, textarea"),g=p[0],b=p[1],y=p[2],u=p[3],m=p[4],f=p[5];(!g||!g.value.trim())&&t.push(`กรุณากรอกบริษัทปลายทางสำหรับงาน #${c+1}`),(!b||!b.value.trim())&&t.push(`กรุณากรอกจังหวัดส่งของสำหรับงาน #${c+1}`),(!y||!y.value.trim())&&t.push(`กรุณากรอกเขต/อำเภอส่งของสำหรับงาน #${c+1}`),(!u||!u.value.trim())&&t.push(`กรุณากรอกชื่อผู้รับงานสำหรับงาน #${c+1}`),(!m||!m.value.trim())&&t.push(`กรุณากรอกรายละเอียดงาน #${c+1}`),(!f||isNaN(parseFloat(f.value))||parseFloat(f.value)<=0)&&t.push(`กรุณากรอกจำนวนเงินที่ถูกต้องสำหรับงาน #${c+1}`)}),document.querySelectorAll("#additional-fees-container > div").forEach((d,c)=>{const p=d.querySelector("select"),g=d.querySelector("input");p&&p.value&&(!g||!g.value.trim())&&t.push(`กรุณากรอกจำนวนเงินสำหรับค่าบริการเพิ่มเติม #${c+1}`),g&&g.value.trim()&&(!p||!p.value)&&t.push(`กรุณาเลือกรายการค่าบริการเพิ่มเติม #${c+1}`),g&&g.value.trim()&&p&&p.value&&(isNaN(parseFloat(g.value))||parseFloat(g.value)<=0)&&t.push(`กรุณากรอกจำนวนเงินที่ถูกต้องสำหรับค่าบริการเพิ่มเติม #${c+1}`)}),t}function K(e){if(!e||!e.includes("/"))return new Date;const t=e.split("/");if(t.length!==3)return new Date;const r=parseInt(t[0]),o=parseInt(t[1])-1,i=parseInt(t[2])-543;return new Date(i,o,r)}function L(){const e=document.getElementById("new-job-form");e&&e.reset();const t=document.getElementById("edit-job-id");t&&(t.value="");const r=document.getElementById("job-date-picker");r&&!t.value&&(r.value=C(new Date),r.removeAttribute("data-original-date"));const o=document.getElementById("job-details-container"),a=document.getElementById("additional-fees-container");o&&(o.innerHTML=`
            <div class="job-detail-card border border-gray-200 rounded-md p-3 mb-3">
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">บริษัทปลายทาง</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อบริษัทปลายทาง" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">จังหวัดส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="จังหวัดส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">เขต/อำเภอส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="เขต/อำเภอส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">ผู้รับงาน</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อผู้รับงาน" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">รายละเอียด</label>
                    <textarea class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="รายละเอียดงาน" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-gray-600 mb-1">จำนวนเงิน (บาท)</label>
                    <input type="number" class="w-full p-3 border border-gray-300 rounded-md amount-input touch-target" placeholder="0.00" min="0" step="0.01" value="0" required>
                </div>
            </div>
        `),a&&(a.innerHTML=""),document.querySelectorAll(".amount-input").forEach(n=>{n.addEventListener("input",w)}),w(),console.log("Form reset completed. Edit job ID cleared:",document.getElementById("edit-job-id").value)}const H=document.getElementById("new-job-form");H&&H.addEventListener("submit",async function(e){if(e.preventDefault(),document.getElementById("new-job-form").checkValidity()){Swal.fire({title:"กำลังบันทึกข้อมูล...",text:"กรุณารอสักครู่",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const o=T();await F(o,!1),await Swal.fire({icon:"success",title:"บันทึกสำเร็จ!",text:`งาน ${o.jobId} ถูกบันทึกเรียบร้อยแล้ว`,confirmButtonText:"ตกลง",confirmButtonColor:"#10b981"}),B(),L(),D("home-screen")}catch(o){console.error("Error submitting form:",o);let a="เกิดข้อผิดพลาด!",i=o.message||"ไม่สามารถบันทึกงานได้ กรุณาลองใหม่อีกครั้ง";o.message&&o.message.includes("หมดเวลา")?(a="การเชื่อมต่อใช้เวลานานเกินไป",i="การเชื่อมต่อกับเซิร์ฟเวอร์ใช้เวลานานเกินไป โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):o.message&&o.message.includes("ไม่สามารถเชื่อมต่อ")?(a="ไม่สามารถเชื่อมต่อได้",i="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):o.message&&o.message.includes("Failed to collect form data")&&(a="ข้อมูลไม่ถูกต้อง",i="ข้อมูลในฟอร์มไม่ถูกต้อง กรุณาตรวจสอบข้อมูลที่กรอก"),await Swal.fire({icon:"error",title:a,text:i,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}else if((await Swal.fire({icon:"warning",title:"ข้อมูลไม่ครบถ้วน",text:"กรุณาตรวจสอบข้อมูลที่กรอก ต้องการบันทึกงานแบบไม่สมบูรณ์หรือไม่?",showCancelButton:!0,confirmButtonText:"บันทึกแบบไม่สมบูรณ์",cancelButtonText:"ยกเลิก",confirmButtonColor:"#f97316",cancelButtonColor:"#6b7280"})).isConfirmed){Swal.fire({title:"กำลังบันทึกข้อมูล...",text:"กรุณารอสักครู่",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const a=T();a.status="incomplete",a.incompleteReason="ข้อมูลไม่ครบถ้วน",await F(a,!1),await Swal.fire({icon:"warning",title:"บันทึกแบบไม่สมบูรณ์",text:`งาน ${a.jobId} ถูกบันทึกแล้ว แต่ข้อมูลไม่สมบูรณ์`,confirmButtonText:"ตกลง",confirmButtonColor:"#f97316"}),B();const i=[{id:a.jobId,reason:"ข้อมูลไม่ครบถ้วน"}],n=document.getElementById("incomplete-jobs-card"),s=document.getElementById("incomplete-jobs-list");n.classList.remove("hidden"),s.innerHTML="",i.forEach(l=>{const d=document.createElement("li");d.textContent=`${l.id}: ${l.reason}`,d.className="cursor-pointer hover:text-indigo-600",d.onclick=function(){k(l.id)},s.appendChild(d)}),L(),D("home-screen")}catch(a){console.error("Error submitting incomplete form:",a);let i="เกิดข้อผิดพลาด!",n=a.message||"ไม่สามารถบันทึกงานได้ กรุณาลองใหม่อีกครั้ง";a.message&&a.message.includes("หมดเวลา")?(i="การเชื่อมต่อใช้เวลานานเกินไป",n="การเชื่อมต่อกับเซิร์ฟเวอร์ใช้เวลานานเกินไป โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):a.message&&a.message.includes("ไม่สามารถเชื่อมต่อ")?(i="ไม่สามารถเชื่อมต่อได้",n="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้ โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตของคุณ"):a.message&&a.message.includes("Failed to collect form data")&&(i="ข้อมูลไม่ถูกต้อง",n="ข้อมูลในฟอร์มไม่ถูกต้อง กรุณาตรวจสอบข้อมูลที่กรอก"),await Swal.fire({icon:"error",title:i,text:n,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}});const U=document.querySelectorAll(".status-filter");U&&U.forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".status-filter").forEach(o=>{o.classList.remove("active"),o.classList.remove("bg-blue-100"),o.classList.remove("border-blue-300"),o.classList.add("bg-white"),o.classList.add("border-gray-300")}),this.classList.add("active"),this.classList.add("bg-blue-100"),this.classList.add("border-blue-300");const t=this.getAttribute("data-status");document.querySelectorAll(".job-item").forEach(o=>{t==="all"||o.getAttribute("data-status")===t?o.style.display="block":o.style.display="none"})})});async function V(e=!1){(e||!oe())&&Swal.fire({title:"กำลังโหลดประวัติงาน...",allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const t=await q(e);console.log("Loaded saved jobs:",t);const r=document.getElementById("job-history-container"),o=document.getElementById("no-jobs-message");if(r&&o){if(t.length===0){o.style.display="block",Swal.close();return}o.style.display="none",t.sort((s,l)=>new Date(l.timestamp||0)-new Date(s.timestamp||0));const a=new Date;a.setDate(a.getDate()-30);const i=t.filter(s=>new Date(s.timestamp)>=a);if(r.querySelectorAll(".job-item").forEach(s=>s.remove()),i.length===0){o.style.display="block",o.querySelector("p:first-of-type").textContent="ไม่พบประวัติงานใน 30 วันล่าสุด",Swal.close();return}i.forEach(s=>{const l=ne(s);r.insertBefore(l,o)})}Swal.close()}catch(t){Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:t.message,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function oe(){const e=S("mangpongJobsLastUpdate");if(!e)return!1;const t=Date.now()-5*60*1e3;return parseInt(e)>t}function ne(e){console.log("Creating job history item for job:",e);const t=document.createElement("div");t.className="card bg-white p-4 mb-4 job-item",t.setAttribute("data-status",e.status||"complete");const r=re(e.status),o=_(e.timestamp);t.innerHTML=`
        <div class="flex justify-between items-start mb-1">
            <h3 class="font-medium">${e.jobId}</h3>
            <span class="px-2 py-1 text-xs rounded-full ${r.class}">${r.text}</span>
        </div>
        <div class="text-sm text-gray-600 mb-2">
            <p>วันที่: ${o}</p>
            <p>บริษัท: ${e.company||"ไม่ระบุ"}</p>
            <p>ผู้ติดต่อ: ${e.assignedBy||"ไม่ระบุ"}</p>
            <p>จำนวน: ${e.totalAmount?e.totalAmount.toFixed(2):"0.00"} บาท</p>
        </div>
        ${e.status==="incomplete"?`
            <div class="bg-red-50 border-l-4 border-red-500 p-2 text-sm text-red-700 mb-2">
                <p>เหตุผลไม่สมบูรณ์: ${e.incompleteReason||"ข้อมูลไม่ครบถ้วน"}</p>
            </div>
        `:""}
        ${e.status==="draft"?`
            <div class="bg-amber-50 border-l-4 border-amber-500 p-2 text-sm text-amber-700 mb-2">
                <p>สถานะ: บันทึกเป็นร่าง</p>
            </div>
        `:""}
        <div class="flex space-x-2">
          <button class="text-sm text-indigo-600 font-medium flex items-center touch-target" onclick="editJob('${e.jobId}')">
            ${e.status==="draft"?"แก้ไขร่าง":e.status==="incomplete"?"แก้ไขงานไม่สมบูรณ์":"แก้ไขงาน"}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
          </button>
        </div>
    `,console.log("Created job element HTML:",t.innerHTML),console.log("Job element:",t);const a=t.querySelector('[data-action="edit"]'),i=t.querySelector('[data-action="view"]');return a&&console.log("Edit button data-job-id:",a.getAttribute("data-job-id")),i&&console.log("View button data-job-id:",i.getAttribute("data-job-id")),t}function re(e){switch(e){case"incomplete":return{class:"incomplete-badge",text:"ไม่สมบูรณ์"};case"draft":return{class:"draft-badge",text:"ร่าง"};default:return{class:"complete-badge",text:"สมบูรณ์"}}}const R=document.getElementById("filter-date-btn");R&&R.addEventListener("click",function(){const e=new Date(document.getElementById("selected-date").value),t=new Date(e);t.setHours(0,0,0,0);const r=new Date(e);r.setHours(23,59,59,999);const o=document.querySelectorAll(".job-item");let a=!1;o.forEach(s=>{const c=s.querySelector(".text-sm.text-gray-600 p:first-child").textContent.replace("วันที่: ","").split("/");if(c.length===3){const p=parseInt(c[0]),b={"ม.ค.":0,"ก.พ.":1,"มี.ค.":2,"เม.ย.":3,"พ.ค.":4,"มิ.ย.":5,"ก.ค.":6,"ส.ค.":7,"ก.ย.":8,"ต.ค.":9,"พ.ย.":10,"ธ.ค.":11}[c[1]],y=parseInt(c[2])-543,u=new Date(y,b,p);if(u>=t&&u<=r){const m=document.querySelector(".status-filter.active").getAttribute("data-status");m==="all"||s.getAttribute("data-status")===m?(s.style.display="block",a=!0):s.style.display="none"}else s.style.display="none"}});const i=document.getElementById("no-jobs-message");i&&(a?i.style.display="none":(i.style.display="block",i.querySelector("p:first-of-type").textContent="ไม่พบงานในวันที่เลือก"));const n=document.querySelector("#history-screen p.text-xs.text-gray-500");if(n){const s=_(e.toISOString());n.textContent=`แสดงข้อมูลวันที่ ${s}`}});async function k(e){try{if(!e)throw new Error("Job ID is required");le("กำลังโหลดข้อมูลสำหรับแก้ไข...");const r=(await q()).find(o=>o.jobId===e);if(!r){J(),Swal.fire({icon:"error",title:"ไม่พบงาน",text:`ไม่สามารถหางานรหัส ${e} ได้`,confirmButtonText:"ตกลง"});return}ae(r),D("new-job-screen"),J()}catch(t){J(),Swal.fire({icon:"error",title:"เกิดข้อผิดพลาด",text:`ไม่สามารถแก้ไขงานได้: ${t.message}`,confirmButtonText:"ตกลง",confirmButtonColor:"#ef4444"})}}function ae(e){try{if(!e||typeof e!="object")throw new Error("Invalid job data provided");if(!e.jobDetails&&e.jobCount>0){const n=[];for(let s=1;s<=e.jobCount;s++)n.push({destinationCompany:e["companyTo"+s]||"",deliveryProvince:e["province"+s]||"",deliveryDistrict:e["district"+s]||"",recipient:e["recipient"+s]||"",description:e["detail"+s]||"",amount:parseFloat(e["amount"+s])||0});e.jobDetails=JSON.stringify(n)}if(!e.additionalFees&&e.feeCount>0){const n=[];for(let s=1;s<=e.feeCount;s++)n.push({description:e["feeName"+s]||"",amount:parseFloat(e["feeAmount"+s])||0});e.additionalFees=JSON.stringify(n)}const t=document.getElementById("new-job-form");if(!t)return;if(document.getElementById("edit-job-id").value=e.jobId,console.log("Editing job:",e.jobId,"with data:",e),e.company){const n=t.querySelector("select");n&&(n.value=e.company)}if(e.assignedBy){const n=t.querySelector('input[placeholder="ชื่อผู้มอบงาน"]');n&&(n.value=e.assignedBy)}if(e.contact){const n=t.querySelector('input[placeholder="ข้อมูลติดต่อ"]');n&&(n.value=e.contact)}if(e.pickupProvince){const n=t.querySelector('input[placeholder="จังหวัด"]');n&&(n.value=e.pickupProvince)}if(e.pickupDistrict){const n=t.querySelector('input[placeholder="เขต/อำเภอ"]');n&&(n.value=e.pickupDistrict)}if(e.jobDate){const n=K(e.jobDate),s=document.getElementById("job-date-picker"),l=document.getElementById("original-job-date");if(s){s.value=C(n),l&&(l.value=e.jobDate),s.removeAttribute("title");const d=s.closest(".mb-3");if(d){const c=d.querySelector(".date-edit-indicator");c&&d.removeChild(c)}}}const r=document.getElementById("job-details-container");if(!r)return;r.innerHTML="";let o=[];if(e.jobDetails){try{o=JSON.parse(e.jobDetails),console.log("Parsed job details:",o)}catch(n){console.error("Error parsing job details:",n),o=[]}o.forEach((n,s)=>{if(s===0){const l=document.createElement("div");l.className="job-detail-card border border-gray-200 rounded-md p-3 mb-3",l.innerHTML=`
                        <div class="mb-2">
                            <label class="block text-gray-600 mb-1">บริษัทปลายทาง</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อบริษัทปลายทาง" value="${n.destinationCompany||""}" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-gray-600 mb-1">จังหวัดส่งของ</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="จังหวัดส่งของ" value="${n.deliveryProvince||n.deliveryLocation||""}" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-gray-600 mb-1">เขต/อำเภอส่งของ</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="เขต/อำเภอส่งของ" value="${n.deliveryDistrict||""}" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-gray-600 mb-1">ผู้รับงาน</label>
                            <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อผู้รับงาน" value="${n.recipient||""}" required>
                        </div>
                        <div class="mb-2">
                            <label class="block text-gray-600 mb-1">รายละเอียด</label>
                            <textarea class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="รายละเอียดงาน" rows="2" required>${n.description||""}</textarea>
                        </div>
                        <div>
                            <label class="block text-gray-600 mb-1">จำนวนเงิน (บาท)</label>
                            <input type="number" class="w-full p-3 border border-gray-300 rounded-md amount-input touch-target" placeholder="0.00" min="0" step="0.01" value="${n.amount||0}" required>
                        </div>
                    `,r.appendChild(l),l.querySelector(".amount-input").addEventListener("input",w)}else{const l=document.getElementById("add-job-detail");l&&l.click();const c=r.lastElementChild.querySelectorAll("input, textarea");c[0]&&(c[0].value=n.destinationCompany||""),c[1]&&(c[1].value=n.deliveryProvince||n.deliveryLocation||""),c[2]&&(c[2].value=n.deliveryDistrict||""),c[3]&&(c[3].value=n.recipient||""),c[4]&&(c[4].value=n.description||""),c[5]&&(c[5].value=n.amount||0)}})}else{const n=document.createElement("div");n.className="job-detail-card border border-gray-200 rounded-md p-3 mb-3",n.innerHTML=`
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">บริษัทปลายทาง</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อบริษัทปลายทาง" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">จังหวัดส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="จังหวัดส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">เขต/อำเภอส่งของ</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="เขต/อำเภอส่งของ" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">ผู้รับงาน</label>
                    <input type="text" class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="ชื่อผู้รับงาน" required>
                </div>
                <div class="mb-2">
                    <label class="block text-gray-600 mb-1">รายละเอียด</label>
                    <textarea class="w-full p-3 border border-gray-300 rounded-md touch-target" placeholder="รายละเอียดงาน" rows="2" required></textarea>
                </div>
                <div>
                    <label class="block text-gray-600 mb-1">จำนวนเงิน (บาท)</label>
                    <input type="number" class="w-full p-3 border border-gray-300 rounded-md amount-input touch-target" placeholder="0.00" min="0" step="0.01" value="0" required>
                </div>
            `,r.appendChild(n),n.querySelector(".amount-input").addEventListener("input",w)}const a=document.getElementById("additional-fees-container");if(a&&(a.innerHTML=""),e.additionalFees){let n=[];try{n=JSON.parse(e.additionalFees),console.log("Parsed additional fees:",n)}catch(s){console.error("Error parsing additional fees:",s),n=[]}n.forEach(s=>{const l=document.getElementById("add-fee");l&&l.click();const d=a.lastElementChild,c=d.querySelector("select"),p=d.querySelector("input");c&&p&&(c.value=s.description||"",p.value=s.amount||0)})}w();const i=document.getElementById("main-service-fee");if(i){console.log("Calculating total from jobDetails:",o);const n=o.reduce((s,l)=>s+(parseFloat(l.amount)||0),0);console.log("Calculated total amount:",n),i.textContent=n.toFixed(2)+" บาท"}w(),setTimeout(()=>{w(),console.log("Final totals update completed")},100)}catch(t){throw console.error("Error populating form with job data:",t),new Error(`Failed to populate form: ${t.message}`)}}async function B(e=!1){try{const t=await q(e),r=new Date,o=r.toDateString(),a=t.filter(u=>new Date(u.timestamp).toDateString()===o).length,i=t.filter(u=>new Date(u.timestamp).toDateString()===o&&u.status==="complete").length,n=r.getMonth(),s=r.getFullYear(),l=t.filter(u=>{const m=new Date(u.timestamp);return m.getMonth()===n&&m.getFullYear()===s}).length,d=t.length,c=document.getElementById("jobs-today");c&&(c.textContent=a);const p=document.getElementById("completed-today");p&&(p.textContent=i);const g=document.getElementById("monthly-jobs");g&&(g.textContent=l+" งาน");const b=document.getElementById("total-jobs");b&&(b.textContent=d+" งาน");const y=document.getElementById("current-month");if(y){const u=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"],m=r.getFullYear()+543;y.textContent=`${u[n]} ${m}`}}catch(t){console.error("Error updating stats:",t)}}function F(e,t=!1){try{if(!e||typeof e!="object")throw new Error("Invalid job data provided");const r=JSON.parse(S("mangpongJobs")||"[]"),o=document.getElementById("edit-job-id");if(!o)throw new Error("Edit job ID element not found");const a=o.value;if(a){const n=r.findIndex(s=>s.jobId===a);if(n!==-1){const s=r[n];r[n]={...s,...e,jobId:a,timestamp:s.timestamp,username:s.username},console.log("Updated existing job:",a,"with data:",r[n])}else console.warn("Job not found for editing, adding as new:",a),r.push(e)}else r.push(e),console.log("Added new job:",e.jobId);return E("mangpongJobs",JSON.stringify(r)),x({action:a?"updateJob":"createJob",...e,isDraft:t})}catch(r){throw console.error("Error saving job:",r),new Error(`Failed to save job: ${r.message}`)}}function se(){if($()){const e=x;x=function(t){return t._=Date.now(),e(t)}}}document.addEventListener("DOMContentLoaded",function(){try{if(document.getElementById("login-screen")){I("login-screen");const t=S("mangpongUser");if(t)try{h=JSON.parse(t),I("app");const o=document.getElementById("user-display-name");o&&(o.textContent=h.fullName||h.username||"ผู้ใช้งาน"),Y()}catch(o){console.error("Error parsing saved user data:",o),W("mangpongUser")}$()&&(ie(),se());const r=document.querySelector("meta[name=viewport]");r&&r.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"),document.addEventListener("touchstart",function(){},{passive:!0})}else console.warn("Login screen element not found")}catch(e){console.error("Error during DOMContentLoaded:",e),document.getElementById("login-screen")&&I("login-screen")}});function $(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}function ie(){console.log("Applying iOS specific fixes");function e(){const o=window.innerHeight*.01;document.documentElement.style.setProperty("--vh",`${o}px`)}e(),window.addEventListener("resize",e),window.addEventListener("orientationchange",e),document.querySelectorAll("input, select, textarea").forEach(o=>{(!o.style.fontSize||parseInt(o.style.fontSize)<16)&&(o.style.fontSize="16px"),o.style.webkitAppearance="none",o.style.borderRadius="8px"}),document.querySelectorAll('input[type="date"]').forEach(o=>{o.style.webkitAppearance="none",o.addEventListener("focus",function(){this.style.position="relative",this.style.zIndex="9999"}),o.addEventListener("blur",function(){this.style.position="",this.style.zIndex=""})})}function le(e="กรุณารอสักครู่..."){Swal.fire({title:e,allowOutsideClick:!1,allowEscapeKey:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}})}function J(){Swal.close()}typeof window<"u"&&"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(e=>{console.log("✅ Service Worker registered",e)}).catch(e=>{console.error("❌ Service Worker registration failed",e)});
